% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sim_sitesize_withinvar.R
\name{sim_sitesize_withinvar}
\alias{sim_sitesize_withinvar}
\title{Generate Site Sizes and Within-Site Variances}
\usage{
sim_sitesize_withinvar(
  J = 25,
  nj_mean = 10,
  cv = 0.3,
  nj_min = 5,
  p = 0.5,
  R2 = 0,
  seed = 123,
  set_seed = FALSE
)
}
\arguments{
\item{J}{Integer > 0. Number of sites.}

\item{nj_mean}{Positive numeric. Desired truncated-gamma mean of site sizes.}

\item{cv}{Numeric >= 0. Coefficient of variation for the truncated Gamma.}

\item{nj_min}{Positive numeric. Lower bound for truncation (default 5).}

\item{p}{Numeric in (0,1). Proportion assigned to treatment (defaults to 0.5).}

\item{R2}{Numeric in [0,1). Proportion of variance explained by level-1 covariates
(defaults to 0.0).}

\item{seed}{Optional integer for random seed (default 123).}

\item{set_seed}{Logical. If TRUE and \code{seed} != NULL, sets the global seed (default FALSE).}
}
\value{
A tibble with columns:
\describe{
\item{\code{alpha}}{Shape parameter for truncated Gamma (found via numeric solver).}
\item{\code{beta}}{Rate parameter for truncated Gamma (found via numeric solver).}
\item{\code{n_j_raw}}{Continuous site sizes drawn from truncated Gamma(\code{alpha}, \code{beta}), \eqn{\ge nj_min}.}
\item{\code{n_j}}{Integer-rounded site sizes.}
\item{\code{se2_j}}{Within-site sampling variance, computed as \eqn{\kappa/n_j}, based on the
\eqn{\Bigl(\tfrac{1}{p} + \tfrac{1}{1-p}\Bigr) (1 - R^2)} relationship.}
}
}
\description{
This function (internally using a truncated Gamma distribution) generates site sizes
(\code{n_j}) with a specified mean (\code{nj_mean}) and coefficient of variation
(\code{cv}), imposing a lower bound \code{nj_min}. It also computes the \strong{within-site
sampling variances} (\code{se2_j}) under a Neyman-type design-based perspective, where
the outcome is expressed in \emph{effect size units} (i.e., \eqn{\mathrm{Var}(Y)=1}).
}
\details{
\subsection{Truncated Gamma Approach}{
Internally, the function solves for \eqn{\alpha,\beta} so that:
\deqn{
    E[X \mid X \ge nj_{\min}] = nj_{\mathrm{mean}}, \quad
    Var\bigl(X \mid X \ge nj_{\min}\bigr] = (cv \times nj_{\mathrm{mean}})^2.
  }
We then sample from \eqn{\Gamma(\alpha,\beta)} but \emph{reject} any draws below
\eqn{nj_{\min}}. This is known as accept-reject sampling for a truncated distribution.
The final \eqn{n_j} values are \emph{rounded} to integers.
}
}
\section{Connecting sampling errors to site sizes}{

In effect-size units (\eqn{\mathrm{Var}(Y)=1}), one can approximate the sampling variance
of an estimated site-specific effect \eqn{\hat{\tau}_j} as:
\deqn{
  (\hat{se}_j)^2 = \frac{1}{n_j} \Bigl(\frac{1}{p_j} + \frac{1}{1 - p_j}\Bigr)\,(1 - R^2),
}
where \eqn{n_j} is the site size, \eqn{p_j} is the proportion assigned to treatment
(the propensity score; Rosenbaum & Rubin, 1983), and \eqn{R^2} is the explanatory power
of level-1 covariates. This formula follows a Neyman repeated-sampling approach under
homoskedasticity (see Miratrix, Weiss, & Henderson, 2021). If we further assume a
\emph{constant} proportion \eqn{p} across sites, then
\deqn{
  (\hat{se}_j)^2 = \frac{1}{n_j}\Bigl(\frac{1}{p} + \frac{1}{1 - p}\Bigr)\,(1 - R^2)
  \;=\;\frac{\kappa}{n_j}.
}
By default, this function sets \eqn{p=0.5} and \eqn{R^2=0}, hence \eqn{\kappa=4}, so
that \eqn{(\hat{se}_j)^2=4/n_j}.
}

\examples{
\dontrun{
# Example usage:
df_test <- sim_sitesize_withinvar(
  J = 1000,
  nj_mean = 10,
  cv = 0.5,
  nj_min = 5,
  p = 0.5,    # => kappa=4 if R2=0
  R2 = 0.0,
  seed = 999,
  set_seed = TRUE
)
head(df_test)
}

}
\references{
\itemize{
\item Rosenbaum, P. R., & Rubin, D. B. (1983). The central role of the propensity score
in observational studies for causal effects. \emph{Biometrika}, 70(1), 41–55.
\item Miratrix, L. W., Weiss, M. J., & Henderson, B. (2021). An applied researcher's
guide to estimating effects from multisite individually randomized trials:
Estimands, estimators, and estimates. \emph{Journal of Research on Educational
Effectiveness}, 14(1), 270–308.
}
}
