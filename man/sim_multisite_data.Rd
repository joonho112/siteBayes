% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/sim_multisite_data.R
\name{sim_multisite_data}
\alias{sim_multisite_data}
\title{Simulate a multi-site dataset, optionally with correlation between tau_j and se2_j}
\usage{
sim_multisite_data(
  true_dist = "Gaussian",
  J = 50,
  sigma_tau = 0.25,
  tau = 0,
  variance = 1,
  nu = NULL,
  slant = NULL,
  rho = NULL,
  delta = NULL,
  eps = NULL,
  ups = NULL,
  formula = NULL,
  beta = NULL,
  data = NULL,
  nj_mean = 10,
  cv = 0.3,
  nj_min = 5,
  p = 0.5,
  R2 = 0,
  precision_dependence = FALSE,
  rank_corr = NULL,
  pearson_corr = NULL,
  max_iter = 20000,
  tol = 0.01,
  set_seed = FALSE
)
}
\arguments{
\item{true_dist}{A character string specifying the type of distribution to use.
Options are \code{"Gaussian"}, \code{"T"}, \code{"Skew"}, \code{"ALD"}, or \code{"Mixture"}.}

\item{J}{A positive integer indicating the number of sites (default: 50). If \code{formula}
and \code{data} are provided, then \code{J} must match \code{nrow(data)}
(or be explicitly set to that).}

\item{sigma_tau}{A positive number to scale the generated treatment effects (default: 0.25).}

\item{tau}{A numeric value specifying an overall offset for the site means (default: 0).}

\item{variance}{A positive number specifying the baseline variance for the distribution (default: 1).}

\item{nu}{Degrees of freedom for the T distribution. Must be provided if \code{true_dist = "T"}.}

\item{slant}{A numeric value for the skew parameter in the Skew Normal distribution.
Must be provided if \code{true_dist = "Skew"}.}

\item{rho}{A numeric value for the parameter in the Asymmetric Laplace distribution (ALD).
Must be provided if \code{true_dist = "ALD"}.}

\item{delta}{A numeric value for the Mixture distribution (must be provided if \code{true_dist = "Mixture"}).}

\item{eps}{A numeric value (typically between 0 and 1) for the Mixture distribution.}

\item{ups}{A positive numeric value for the Mixture distribution.}

\item{formula}{An optional model formula describing how covariates in \code{data} should be used
to form the design matrix. For example, \code{~ X1 + X2} or \code{~ 0 + X1 + X2}.
If provided, you must also supply \code{beta} and \code{data}.}

\item{beta}{A numeric vector of regression coefficients corresponding to the columns of
\code{model.matrix(formula, data)}. If \code{formula} is provided,
\code{beta} must have length equal to \code{ncol(model.matrix(...))}.}

\item{data}{An optional data frame containing site-level covariates to be used in \code{formula}.
Must have \code{nrow(data) == J} if provided.}

\item{nj_mean}{Positive numeric. Desired truncated-gamma mean of site sizes.}

\item{cv}{Numeric >= 0. Coefficient of variation for the truncated Gamma.}

\item{nj_min}{Positive numeric. Lower bound for truncation (default 5).}

\item{p}{Numeric in (0,1). Proportion assigned to treatment (defaults to 0.5).}

\item{R2}{Numeric in [0,1). Proportion of variance explained by level-1 covariates
(defaults to 0.0).}

\item{precision_dependence}{Logical (default \code{FALSE}). If \code{TRUE}, will attempt
to induce correlation between \(\tau_j\) and \(\mathrm{se2}_j\). The type of correlation
depends on whether \code{rank_corr} or \code{pearson_corr} is specified (see below).}

\item{rank_corr}{Numeric in \link{-1,1}, optional. If provided (and \code{precision_dependence=TRUE}),
we enforce a \emph{Spearman} correlation target using \code{\link{sim_observed_effects}}
(hill-climbing approach).}

\item{pearson_corr}{Numeric in \link{-1,1}, optional. If provided (and \code{precision_dependence=TRUE}),
we enforce a \emph{Pearson} correlation target using \code{\link{sim_observed_effects_copula}}
(Gaussian copula approach).}

\item{max_iter}{Integer. Maximum number of swap attempts for the hill-climbing approach
(only relevant if \code{rank_corr} is used).}

\item{tol}{Numeric tolerance for stopping early if the current Spearman correlation is
within \code{tol} of \code{rank_corr} (only relevant if \code{rank_corr} is used).}

\item{set_seed}{Logical (default \code{FALSE}). If \code{TRUE}, the function begins by
calling \code{set.seed(123)}, thus making the entire pipeline reproducible.}
}
\value{
A \strong{tibble} with \code{J} rows, containing site index, (optional) covariates,
the true effects \code{tau_j}, the sampling variance \code{se2_j}, the observed
\code{tau_j_hat}, and \code{corr_est}.
}
\description{
This function:
\enumerate{
\item Calls \code{\link{gen_priorG2}} to generate \code{J} site-level "true" effects (including
\code{site_index} and possibly covariates).
\item Calls \code{\link{sim_sitesize_withinvar}} to generate \code{se2_j} for each site.
\item Depending on user input, calls either \code{\link{sim_observed_effects}} (for Spearman rank correlation)
or \code{\link{sim_observed_effects_copula}} (for Pearson correlation) to potentially reorder \code{se2_j}.
\item The function merges these results back into the final data frame, leaving
\code{tau_j} and covariates in their original row order.
}
}
\details{
The returned data frame has columns:
\itemize{
\item \strong{\code{site_index}} (unique ID for each site).
\item \emph{covariates}, if a formula/data were used in \code{\link{gen_priorG2}}.
\item \strong{\code{tau_j}}, the true site effect from \code{gen_priorG2}.
\item \strong{\code{se2_j}}, the (possibly permuted) sampling variance.
\item \strong{\code{tau_j_hat}}, the observed site effect, drawn from \(\mathrm{N}(\tau_j, se2_j)\).
\item \strong{\code{corr_est}}, the final correlation estimate (Spearman or Pearson) between \code{tau_j}
and \code{se2_j}, depending on which method was used.
}

\subsection{Choosing correlation type}{
\itemize{
\item If \code{precision_dependence=FALSE}, no correlation is enforced (we do a random shuffle
so it's near zero).
\item If \code{precision_dependence=TRUE} and \code{rank_corr} is specified (not \code{NULL}),
we use \code{sim_observed_effects} to achieve a Spearman correlation (hill climbing).
\item If \code{precision_dependence=TRUE} and \code{pearson_corr} is specified (not \code{NULL}),
we use \code{sim_observed_effects_copula} to achieve a Pearson correlation (Gaussian copula).
\item If both are specified or neither is specified, we throw an error or interpret it as zero
correlation. You can customize this logic as you prefer.
}
}
}
\examples{
\dontrun{
# Example 1: rank_corr => Spearman correlation ~ 0.4
df_sp <- sim_multisite_data(
  J = 20,
  precision_dependence = TRUE,
  rank_corr = 0.4,
  set_seed = TRUE
)
cor(df_sp$tau_j, df_sp$se2_j, method="spearman") # ~0.4

# Example 2: pearson_corr => Pearson correlation ~ 0.5
df_pe <- sim_multisite_data(
  J = 20,
  precision_dependence = TRUE,
  pearson_corr = 0.5,
  set_seed = TRUE
)
cor(df_pe$tau_j, df_pe$se2_j) # ~0.5
}

}
